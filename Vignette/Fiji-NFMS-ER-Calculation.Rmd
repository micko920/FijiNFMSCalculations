---
runtime: shiny
title: "Fiji NFMS ER Calculations Summary"
author: "David Chambers, Carly Green, Michael Green"
date: "May 2021"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    toc: yes
    toc_depth: '5'
  word_document:
    toc: yes
    toc_depth: '5'
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  echo = TRUE
)

library(nlme)
library(data.table)
library(survey)
library(VGAM)
library(ValueWithUncertainty)
library(MonteCarloUtils)
library(FijiNFMSCalculations)
```

# 1. Introduction

## 1.1 Purpose of Document

This document describes the Fijian Ministry of Forestry approach to calculating
annual emissions and removals from REDD+ Activities and estimation of Emission
Reductions using R language for World Bank Forest Carbon Partnership Facility
(FCPF) Carbon Fund Monitoring Report.

The document:

- Outlines the parameters and outputs of functions used to calculate the
  emissions and removals from REDD+ Activities;
- References the R script functions used to calculate the outputs required for
  the FCPF monitoring report;
- Discusses the outputs from the R calculations with reference to their values,
  associated uncertainty and sensitivity analysis,
- Provides guidance on modification of the code for a change in methodology or
  adoption of a new data set;
- Provides information/code for the packages used to complete the calculations.


The source code covered in this documentation forms part of the Fiji
Information Management System (FIMS). These calculations within the code will
be run as part of normal operations of the FIMS. FIMS will manage the
operational requirements which consists of ensuring the correct inputs to the
code and recording of the outputs.  This code is provided in this format so as
to facilitate the management of updates, testing, and sharing the code with
third parties without the need to establish a correctly installed and
operational instance of the FIMS system.

## 1.2 Audience

There are three main audiences for this document. Each group is listed below
with the intended outcomes for that audience.

The Ministry of Forestry Staff:

- Be able to make changes to the calculations based on methodology changes;
- Find the code that implements calculations for review and auditing of
  processes;
- Communicate to third parties to enable improvements

Consultants:

- Be able to make changes to the calculations based on methodology changes;
- Find the code that implements calculations for review and auditing of
  processes;
- Be able to efficiently and consistently update documentation following
  changes made

Auditors and Reviewers:

- Be able to find code that implements calculations for review and auditing;


## 1.3 Terminology

### Code Naming Convention

The names used in identifiers (functions, objects, values, ...) are based on
the following style:

Scope::Usage::Type::Name

|Scope  |Usage       | Type   | Name
|:----  |:----       |:----   |:----
|Calc   |Est         |Em      | e.g Defor
|Mp     |Net         |Rem     |
|Rp     |Gross       |EmRems  |
|Erpa   |Current     |ERs     |
|       |Previous    |FRL
|       |Transferred |EF
|       |Adj
|       |Contested
|       |Sold

Each field (Scope, Usage, Type, Name) can have the following:

Scope:

- **Calc**: A calculation function returning a result. This will generally have
  the units of CO~2~e.
- **Mp**: Monitoring Period. These values and data are for the whole Monitoring
  Period.
- **Rp**: Reporting Period. These values and data are pro rata values of the
  equivalent MP data and is determined as the ratio of the Reporting Period
  to the Monitoring Period
- **Erpa**: ERPA value which relates to the whole Program Period.

Usage:

- **Est**: An estimate of the data
- **Net**: A sum of estimates which have a -ve and +ve range
- **Gross**: A estimate which has not been adjusted or reduced by the opposite
  estimates. For example emission from Forest Degradation without considering
  removals.
- **Previous**: A running total of the value across all reports but does not
  include this reports estimates.
- **Current**: The running total value which takes in to consideration all
  previous report values as well as the current report estimates.
- **Transferred**: The Emissions Reductions which have been transferred prior
  to this reporting period.
- **Adj**: Values which have been adjusted for buffers.
- **Contested**: Contested Emissions Reductions
- **Sold**: The Emissions Reductions which have been sold prior to this
  reporting period.

Type:

- **EF**: A emission factor used in calculations
- **Em**: A value representing an emission  of CO~2~e, always positive (+ve).
- **Rem**: A value representing an removal  of CO~2~e, always negative (-ve).
- **EmRem**: A value that represents a -ve (removal) or +ve (emission) of
  CO~2~e.
- **ERs**: A value that represents a +ve (reduction) or -ve (reversal) as
  compared to the ERPA Forest Reference Level.
- **FRL**: A value that represents the Forest Reference Level or a sub activity
  of the Forest Reference Level

Name:

The following are examples of names and abbreviations used.

- `EstEmRemsDefor`: is an estimate (Est) of emission/removals (EmRems) for
  deforestation (Defor)
- `MpEstFRL`: is the specific Monitoring Period (Mp) estimate (Est) of the
  Forest Reference Level (FRL)
- `ErpaPreviousERs`: is the ERPA (Erpa) running total not including the
  Monitoring Period of the report (Previous) of the Emission Reductions (ERs)

Other shortened words used are:

- `Enh`: Enhancements, i.e. sinks.
- `FDeg`: Forest Degradation.



### Acronyms

- [] Todo: some Acronyms are being replaced. This list will need to be updated
  on completion.

| Acronym  | Meaning                                       |
| -------- | ----                                          |
| AD       | Activity Data                                 |
| AGB      | Above Ground Biomass                          |
| AR       | Afforestation/Reforestation                   |
| Args     | Arguments                                     |
| BCEF     | Biomass Conversion and Expansion Factor       |
| BGB      | Below Ground Biomass                          |
| Conv     | Conversion                                    |
| DF       | Deforestation                                 |
| Defor    | Deforestation                                 |
| EF       | Emissions Factor                              |
| ER       | Emission Reduction                            |
| ERPA     | Emission Reductions Program Agreement         |
| Em       | Emissions                                     |
| Est      | estimate                                      |
| FD       | Forest Degradation                            |
| FDeg     | Forest Degradation                            |
| FP       | Forest Plantation                             |
| FRL      | Forest Reference Level                        |
| Fell     | Felling                                       |
| ForPlant | Forest Plantation                             |
| GHGS     | Greenhouse Gases                              |
| HW       | Hardwood                                      |
| Harv     | Harvested                                     |
| Inc      | Increment                                     |
| LCI      | Lower Confidence Interval                     |
| MAIAGB   | Mean Annual Increment of Above Ground Biomass |
| MAIB     | Mean Annual Increment of Biomass              |
| MAIC     | Mean Annual Increment of Carbon               |
| MAIV     | Mean Annual Increment of Volume               |
| MC       | Monte Carlo                                   |
| Plant    | Planted                                       |
| Rem      | Removals                                      |
| SD       | Standard Deviation                            |
| SW       | Softwood                                      |
| Stock    | Stocked                                       |
| TEF      | Total Emissions Factor                        |
| Trop     | Tropical                                      |
| UCI      | Upper Confidence Interval                     |
| Vol      | Volume                                        |
| err      | Error                                         |
| ha       | hectare                                       |
| m3       | cubic metre                                   |
| tCO2e    | Tonne of Carbon dioxide equivalent            |
| yr       | year                                          |
| yrs      | years                                         |

## Preliminaries

### Source Code

The source code for the Fiji NFMS Integration framework is separated into a set
of drivers and a set of support packages.

Access to the repository is by invitation only.

- [] Todo: Add contact details: info@enviroaccounts.com

**Drivers**

The drivers are all in a single repository [github::micko920/FijiNFMSIntegration](https://github.com/micko920/FijiNFMSIntegration).
They provide the front end execution interface for running the calculations.

**Packages**

The support code is subdivided into packages based on functionality. They need
to be installed into the R session before the drivers and tests will execute
successfully.

They can be installed with the following commands:
```
devtools::install_github("micko920/ValueWithUncertainty")
devtools::install_github("micko920/FijiNFMSCalculation")
devtools::install_github("micko920/MonteCarloUtils")
```

### Dependencies and R Session Information

The R version and packages required to run the drivers and packages covered by
this document are listed below:
```{r}
sessionInfo()
```

These packages can be installed by using the `requirements.R` file in the
drivers code repository [github::micko920/FijiNFMSIntegration](https://github.com/micko920/FijiNFMSIntegration).


# 2.	R Script Calculations

This section describes the calculations carried out by the R Script to produce
the required values for the FCPF Carbon Fund Monitoring Report. Details and
justifications for the adopted calculation methodology are available in a
separate document titled *REDD+ Calculation Methodology: Fiji*. Relevant
sections of this document are referenced against each of the following
sub-sections should more methodological detail be required.


## 2.1.	REDD+ Activities Annual Estimations

Emissions and removals from REDD+ Activities reported in Fiji fall under the
categories of Deforestation, Forest Degradation and Enhancements.

### 2.1.1.	Deforestation

**Scope**

Deforestation is defined as the conversion of land in the land-use sub-category
Natural Forest (low- or upland) to land in the sub-category non-forest.
Deforestation occurs if the crown-cover percent on a patch of land (min. 0.5
ha) drops below the threshold value of 10%. Deforestation cannot occur within
lands previously defined as plantations as this land is classified as Forest
Land regardless of canopy cover as it primary land use is forest.Emissions from
deforestation from lowland and upland natural forest, excluding areas subject
to logging in Fiji.Areas of forest loss detected in annual remotely sensed
images are combined with data on carbon stocks in defined strata, both of the
pre- and post land cover class (e.g. Pre deforestation land cover class of
Lowland forest and post deforestation class of Grassland).

Annually monitored activity data which drive these estimates include:

- areas of deforestation detected in remotely sensed data.

**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 3
- Package: `FijiNFMSCalculations`
- Script: `Deforestation.R`

**Prior Requirements**

- [] Todo: Data: Hectares of Area Deforested in lowland an upland natural forest.

**Output**

This emissions source provides a contribution to the overall emission/reduction
estimate from REDD+ Activities in Fiji. This value is required for reporting
and further calculation of values in the FCPF Monitoring Report.


### 2.1.2.	Forest Degradation

Emissions from forest degradation are estimated as the combination of the net
emissions/removals from logging in Natural Forests and the emissions from Fire
in Pine Plantations.


#### Felling

**Scope**

Emissions related to felling practices in natural forest are estimated using
the approach proposed by Pearson et al. (2014). This methodology includes
losses from felling operations, including loss from the felled tree itself (AGB
and BGB), logging residues of the felled tree, felling damages to the remaining
stand (AGB and BGB), and losses due to the establishment of felling
infrastructure (e.g., skid trails, roads and log landings).

Annually monitored activity data which drive these estimates include:

- recorded volumes of wood extracted to drive estimates of emissions from
  extraction
- area subject to felling activities to drive estimates of removals from
  regrowth

The net of estimates of emissions from felling and removals from regrowth
provide an annual estimate of emissions/removals from felling activities in
natural forest.

**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 4.1
- Package: `FijiNFMSCalculations`
- Script: `Felling.R`

**Prior Requirements**

- [] Todo: Data

**Output**

This emissions source provides a contribution to the overall emission/reduction
estimate from REDD+ Activities in Fiji. This value is required for reporting
and further calculation of values in the FCPF Monitoring Report.


#### Emissions from Fire

**Scope**

Emissions from fire are estimated from burnt areas in Softwood Plantations
(Pine) owned and managed by Fiji Pine Limited. The methodology estimates carbon
dioxide (CO~2~), methane (CH~4~) and nitrous oxide (N~2~O) emissions from
biomass available for combustion in a compartment and combustion factors
combined with specific characteristics of burnt areas.

Annually monitored data which derive these estimates include:
- year of burning (year);
- area burnt in hectares (ha);
- age in years (yrs) of each burnt area (i.e., the time elapsed since planting).


**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 4.2
- Package: `FijiNFMSCalculations`
- Script: `Burning.R`

**Prior Requirements**

- [] Todo: Data

**Output**

This emissions source provides a contribution to the overall emission/reduction
estimate from REDD+ Activities in Fiji. This value is required for reporting
and further calculation of values in the FCPF Monitoring Report.


### 2.1.3.	Enhancements

Enhancement of forest carbon stocks includes removals from
afforestation/reforestation, as well as net emissions and removals from the
management of softwood and hardwood plantations.


#### Afforestation

**Scope**

Afforestation/Reforestation is defined as the conversion of land in the
land-use sub-category Non-Forest to land in the sub-category Natural Forest
(Low- or Upland) or Plantations (Softwood and Hardwood).
Afforestation/reforestation occurs if the crown-cover percent on a patch of
land (min. 0.5 ha) reaches or exceeds the threshold value of 10%.
Afforestation/reforestation cannot occur within lands previously defined as
plantations as this land is classified as Forest Land regardless of canopy
cover as it primarily land use is forest. New plantations established on lands
that have not previously been a forest are considered
afforestation/reforestation.  It is assumed that afforestation/reforestation
always has anthropogenic causes in Fiji.

Annually monitored activity data which drive these estimates include:

- areas of regrowth detected in remotely sensed data

**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 5.1
- Package: `FijiNFMSCalculations`
- Script: `Afforestation.R`

**Prior Requirements**

- [] Todo: Data

**Output**

This emissions source provides a contribution to the overall emission/reduction
estimate from REDD+ Activities in Fiji. This value is required for reporting
and further calculation of values in the FCPF Monitoring Report.

#### Forest Plantations

**Scope**

Emissions and removals in tCO~2~e from Forest Plantation Management. This
includes the growth and felling of Softwood and Hardwood plantation timber. By
definition, deforestation and afforestation/reforestation is not possible
within Forest Plantations. Forest Plantations remain in the land-use category
Forest Land even if the crown-cover is completely removed following harvest,
e.g., temporarily unstocked.

Estimates of emissions from Forest Plantations rely on annually collected
records of extracted timber volumes. Estimates of removals rely on mean annual
increment (MAI) and area stocked.

Annually monitored activity data which drive these estimates include:

- extracted volumes
- area stocked


**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 5.2
- Package: `FijiNFMSCalculations`
- Script: `ForestPlantations.R`

**Prior Requirements**

- [] Todo: Data

**Output**

This emissions source provides a contribution to the overall emission/reduction
estimate from REDD+ Activities in Fiji. This value is required for reporting
and further calculation of values in the FCPF Monitoring Report.


### 2.1.4.	Annual Net Emissions/Removals from REDD+ Activities

**Scope**

Annual net Emissions/Removals represent the summation of emissions and removals
from the REDD+ activities: Deforestation, Forest Degradation and Enhancements
for one year.

**Reference**

- Methodology Fiji REDD+ Calculation Methodology - Section 6
- Package: `FijiNFMSCalculations`
- Script: `EmissionReductions.R`

**Prior Requirements**

Calculation of all REDD+ activities (Deforestation, Forest Degradation, Enhancements)

**Output**

The values of net emissions and removals are reported in the FCPF Monitoring
Report and are used to calculate Emissions Reductions against the Forest
Reference Level (FRL)


## 2.2.	Emission Reductions

Emission Reductions represent the change in emissions during a specified
Monitoring Period when compared to the Forest Reference Level.


**Scope**

Emission Reductions are calculated as the difference between the Forest
Reference Level (an average to annual emissions/removals from all included
REDD+ Activities between 2006 - 2016) and the calculated annual average
emissions/removals during the Monitoring Period minus any required
risk/uncertainty buffer deductions.

**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 8
- Package: `FijiNFMSCalculations`
- Script: `ForestPlantations.R`

**Prior Requirements**

Forest Reference Level (FRL) from Fiji Ministry of Forestry
Net Emissions/Removals value for the monitoring period.

**Output**

The value of Emission Reductions is reported in the FCPF Monitoring Report.


## 2.3.	Outputs for FCPF Monitoring Report

**Scope**

The outputs from the R script calculation are used to populate the FCPF
Monitoring report for a specified Reporting Period. In particular Tables 4.2,
4.3, 5.2.2, 7.2 and 8 of the ER Monitoring Report Template are populated from
the outputs of this R Script.

**Reference**

- Methodology: Fiji REDD+ Calculation Methodology - Section 9
- Package: `FijiNFMSIntegration`
- Script: `Funcs/TableCreationFunction.R`

**Prior Requirements**

Calculation of all REDD+ activities (Deforestation, Forest Degradation,
Enhancements), Emissions Reductions and net emissions/removal values.

**Output**

Values to be reported in the FCPF monitoring report including Tables 4.2, 4.3,
5.2.2, 7.2 and 8.

# 3.	Discussion

This section provides has some high-level design details and instruction for
using the packages. For more detail please refer to the internal
documentation for each package.

This section includes:

- **Script Parameters**: Parameters and data that control how the R Script
  executes
- **Drivers**: Details on executing a specific set of calculations to
  produce a subset output for the Monitoring Report
- **Modification of the Code**: Modular code may be replaced or require
  updating as the context and methodology is updated.
- **Testing and Unit Testing**: Confirmation that the code is operating
  correctly

## 3.x.	Script Parameters
### Monitoring Report Parameters

- [] Todo: Add detail about Report Parameters - CG

### Monitored Values

- [] Todo: Add detail about Monitored Values - CG

### Burn Data

- [] Todo: Add detail about Burn Data - CG

## 3.1.	Drivers

The drivers provide a way to execute the calculations and generate specific
output for the Monitoring Report. They have been broken up based on the
execution time to produce the output.

The 3 drivers are:

- Values: Performs the calculations to produce basic emissions and removals and
  gross emission reduction calculations without uncertainty or adjustments or
  running totals.
- Uncertainty: Performs the basic value calculations with uncertainty propagation.
- Sensitivity: Performs sensitivity analysis of parameters on the uncertainty
  of the final calculations.


Each driver has three forms of output:

- Console: simple execution messages to show that the code is running. It may
  output some values when complete.
- Text file: The drivers will write important calculated values to a text file
  with the name of the driver. This output is captured for testing and
  automation processes.
- R session environment: The drivers will populate variables in the global
  environment as part of the their execution. These values can be explored via
  RStudio or saving the RData file after executing the driver in a R session.

See individual driver sections for specific purpose and outputs.

### Guidance: Opening and Running a Driver

- Open R Studio
  - ![Step1][OpenRStudio]
- Set working directory to file directory
  - ![Step2][SetWorkingDirectory]
- Open Driver file
  - ![Step3][OpenDriverFile]
- Run file (Ctrl+alt+r, through code menu or on console source("./driverfilename.R"))
  - ![Step4][RunFile]
- Check the outputs in the environment.
  - ![Step5][CheckOutputsEnv]
- Check the outputs in the console.
  - ![Step5][CheckOutputsConsole]

[OpenRStudio]:images/1RStudioOpeningPage.png
[SetWorkingDirectory]:images/2SetWorkingDirectory.png
[OpenDriverFile]:images/3OpenScript.png
[RunFile]:images/4RunScript.png
[CheckOutputsEnv]:images/5ResultsOfRun-Env.png
[CheckOutputsConsole]:images/5ResultsOfRun-Console.png

For more guidance on using RStudio please refer to the RStudio website [RStudio Support](https://support.rstudio.com/hc/en-us)

### 3.1.1.	Values

**Purpose**

The Values driver produces estimates without uncertainty. These calculations
are quick to run but only provide the following results for the Monitoring
Report:

- Yearly EmRems
- Monitoring Period Gross ERs
- Reporting period Emission Reduction Program Agreement (ERPA) balance of ERs.

The same calculations are then used by the Value with Uncertainty Driver and
the Sensitivity Analysis Driver.

**Output**

- `EmRems_Values`: Emission and removals estimates
- `ER_Values`: Potential ERs before deductions or buffering
- `MR_Values`: Monitoring Report Values used to create table output

Produces Tables 4.2, 4.3 for the FCPF Monitoring Report.
- `Table4_2`
- `Table4_3`

### 3.1.2.	Values with Uncertainty

**Purpose**

The Values with uncertainty driver provides estimates with uncertainty for the
Monitoring Period data and the Emission Reductions available for transfer to
the Carbon Fund. This driver uses the estimation calculations in multiple
layers of Monte Carlo Simulations. The values used in the calculations have a
modeled uncertainty. The Monte Carlo simulations are used to produce an upper
and lower values of the confidence interval for the calculations.

The values and the associated uncertainty models used in the calculations are
encapsulated in an R Object called ValueWithUncertainty. This object is detailed
in the package of the same name.

- [] Todo: Reference the ValueWithUncertainty package and documentation.

The purpose of using this R Object encapsulation was to ease the process of
selectively turning the uncertainty off and on for individual values used in
the calculations.

Each ValueWithUncertainty R Object can either be a numeric value
as a result of sampling the model of variation or it can be the 'fixed'
estimate. When the object is fixed all references to the object will return a
fixed numeric value which was the original estimated value.

When sampling is enabled the reference to the value will return a sampled value
with the probability based on the model associated with the values
uncertainty.  This allows the code to remain consistent for both straight line
calculations where no uncertainty is considered and calculations with
uncertainty of all variables considered, as well as combinations of both. See
the section on sensitivity analysis.

**Propagation of uncertainty using Monte Carlo Simulations:**

- [] Todo: Reference the Monte Carlo Utils package and documentation.

The uncertainty of the values and the results of the calculations are propagated
through to the final estimate via Monte Carlo simulation techniques.

Each time a Monte Carlo simulation is performed the results are captured in a
ValueWithUncertainty R Object. This allows the value and the model to be used
in subsequent calculations and Monte Carlo simulations. The probability
distribution model used to represent the Monte Carlo calculation results is a
sample of samples model, i.e. a bootstrap.  The sample of samples model uses
the results of the Monte Carlo simulation as the source of values which it then
samples uniformly.

The Monte Carlo simulation uses a algorithm with an internal stopping condition
based on either a limit of the number of iterations or the
stabilisation with tolerance of the 90% CI, Which ever happens first. If
the 90% CI stabilises with a specified tolerance the simulation is stopped.
Otherwise the simulation continues until the number of interactions is reached.

The stabilisation condition of the 90% CI was used as it directly affects the
range of the uncertainty. Stabilisation of the mean happens relatively early
with some calculations in the simulation while the confidence interval may be
still unstable. If the smaller set of results are used as the model of
uncertainty for the calculation it could cause bias or inaccurate ranges of
uncertainty which will affect further propagation.

Using this stopping algorithm allows the Monte Carlo simulation the opportunity
to complete as early as possible when a calculation is relatively stable rather
than doing repeated unnecessary iterations. See the package documentation for
more details on this algorithm. This is important for the sensitive analysis as
some values become fixed and so do not need the same number of runs to
propagate the uncertainty effectively. This stopping algorithm automatically
reduces execution time dramatically.

The method of iteration used in the Monte Carlo simulation is the `replicate`
function. This was used as it is orders of magnitude faster than a `for` loop
and a little more convient than the apply functions.  The function could be
replaced with multi core equivalents, but the issues of statistically
sound parallel random number generation would need to be taken into
consideration. This was deamed as unnessary in the context of the size of the
data and number of iterations required.

To control the Monte Carlo iterations there are two parameters set at the start
of the script.

- `MCRuns`: (Default: 1.5e+06) the limit the number of runs in MC simulation
- `MCTolerance`: (Default: 0.01) how stable the UCI and LCI should be before
  stopping

The default values above will have an execution time of about 1 min on the single
core such as a Intel i7-7700HQ CPU @ 2.80GHz, with around 1.0e+4 iterations per
Monte Carlo simulation.

Reducing the `MCTolerance` to 0.0025 will mean the excution time will take in the
order of 10mins, with around 1.5e+5 iterations per Monte Carlo simulation.

Changing the `MCRuns` to a higher number will not enforce more iterations.  The
`MCTolerance` will also need to be reduced.

The simulations can be visualised by enabling `plot_mc_output`. Setting this
value to `TRUE` will plot the results of the Monte Carlo simulations and the
stopping algorithm data.

The 4 plots produced are:

- A frequency plot of the samples produced in the Monte Carlo simulation.
- A box chart of the samples with points marked for the 90% CI and the estimate.
- A log graph of standard deviations assessments of the width of the 90% CI for
  the MC samples over the increasing number of Monte Carlo iterations.
- A log graph of the 90% CI at each stopping assessment.

It can be seen in a number of plots that the CI changes as the number of
interations are increased. Also it can be seen in the boxcharts the estimate
appearing to lie in the extreams of the unceratinaty. This is being investigated.


**Independent, Partially, and Shared sources of uncertainty:**

Some calculations share a dependence on common values with an associated
uncertainty. The results from these calculations are then used in further
calculations which will result in a combination of independent (zero
correlation) sources of uncertainty, partially (mixed correlation) dependent
sources of uncertainty, and shared (fully correlated) sources of uncertainty.

The FCPF guidance warns against treating all sources of uncertainty as
independent.  This will underestimate the interactions of the shared and
partially shared uncertainty with other input variables in related
calculations.

The suggested solution is to use a single sample of the value based on the
uncertainty for all calculations conducted in a single simulation. This will
then ensure that the interdependence and effect of the uncertainty is correctly
carried through the whole simulation and final estimates.

The Fiji calculations did not use this method. To mitigate the effects of the
shared and partially shared sources of uncertainty the Monte Carlo simulations
are done at a number of calculation levels to propagate the uncertainty to
other related calculations.

This has the effect of 'exercising' the full range of the uncertainty for all
shared and partially shared sources of uncertainty for all calculations
completely.

**Output**

- `EmRems_Values`: Emission and removals estimates.
- `ER_Values`: Potential ER's before deductions or buffering.
- `MR_Values`: Monitoring Report Values used to create table output.
- `ResultsTables`: This table is a 'replica' of the original FRL table
  generated for Fiji. It allows some lower lever reporting for internal
  stakeholders.
- `UC_Values`: The ValueWithUncertainty models for the Emission Factors and
  other default input parameters.
- `UC_MV_Values`: The ValueWithUncertainty models for the Monitored Values.
- `UC_EmRems_Values`: The confidence intervals, Monte Carlo results for the
  Emissions Removal estimates.
- `UC_ER_Values`: The confidence intervals, Monte Carlo results, and Half
  Width, relative margin and conservative factors for the Emissions removals
  estimates.

Produces Tables 4.2, 4.3, 5.2.2, 7.2 and 8 for the FCPF Monitoring Report.
- `Table4_2`
- `Table4_3`
- `Table5_2_2`
- `Table7_2`
- `Table8`


### 3.1.3.	Sensitivity Analysis

**Purpose**

The Sensitivity Analysis produces a report which assesses the Total Effect
Index of parameters for which uncertainty is included in the calculations.  Not
all parameters and sources of uncertainty are assessed.

- [] Todo: Reference Uncertainty list and list of assessed parameters.
- [] Todo: Reference (Word document with value with uncertainty defined) either
  in CG document (link) or coding table with parameter and code name........

The Fiji Code uses the Total Effect Index method for ranking the parameters
effects on the overall uncertainty. The ranking of the parameters allows
prioritizing improvements to those which will have the biggest impact to
reducing the overall uncertainty.

This method has been implemented from guidance provided from the FCPF.

- [] Todo: Reference World Bank UC guidance document received from Rama
- [] Todo: Reference World Bank UC Power Point presentation from Andres

The following description provides a basis for explaining design decisions
related to the implementation of the Sensitivity Analysis. More information
about the implementation and the algorithm can be found in the package
documentation.

**Total-effect index:**

- [] Todo: Needs more work, this was extracted from wiki pages. But provides
  the knowledge needed to understand the results!!
[Wikipedia_Sensitvity_Analysis]:https://en.wikipedia.org/wiki/Sensitivity_analysis
[Wikipedia_Variance_Based_Sensitvity_Analysis]:https://en.wikipedia.org/wiki/Variance-based_sensitivity_analysis
[Python_Sensitvity_Analysis]:https://uncertainpy.readthedocs.io/en/latest/theory/sa.html

*First-order indices*

A direct variance-based measure of sensitivity S~i~, called the "first-order
sensitivity index", or "main effect index" is stated as follows,[1]

$$ S_{i}={\frac  {V_{i}}{\operatorname {Var}(Y)}} $$

This is the contribution to the output variance of the main effect of X~i~,
therefore it measures the effect of varying X~i~ alone, but averaged over
variations in other input parameters. It is standardised by the total variance
to provide a fractional contribution. Higher-order interaction indices S~ij~,
S~ijk~ and so on can be formed by dividing other terms in the variance
decomposition by Var(Y). Note that this has the implication that,

$$ \sum _{{i=1}}^{d}S_{i}+\sum _{{i<j}}^{{d}}S_{{ij}}+\cdots +S_{{12\dots d}}=1 $$


Using the S~i~, S~ij~ and higher-order indices given above, one can build a picture
of the importance of each variable in determining the output variance. However,
when the number of variables is large, this requires the evaluation of 2d-1
indices, which can be too computationally demanding. For this reason, a measure
known as the "Total Effect index" or "Total Order index", S~Ti~, is used.[2] This
measures the contribution to the output variance of X~i~, including all variance
caused by its interactions, of any order, with any other input variables. It is
given as,

$$ S_{Ti}=\frac {E_{{\textbf {X}}_{\sim i}}\left(\operatorname {Var}_{X_{i}}(Y\mid \mathbf {X}_{\sim i})\right)}{\operatorname {Var} (Y)}=1-\frac {\operatorname {Var}_{{\textbf {X}}_{\sim i}}\left(E_{X_{i}}(Y\mid \mathbf {X}_{\sim i})\right)}{\operatorname {Var} (Y)} $$


Note that unlike the S~i~,

$$ \sum_{{i=1}}^{d}S_{{Ti}}\geq 1 $$

due to the fact that the interaction effect between e.g. X~i~ and X~j~ is counted
in both S~Ti~ and S~Tj~ In fact, the sum of the S~Ti~ will only be equal to 1 when
the model is purely additive.

[1] Sobol’, I. (1990). Sensitivity estimates for nonlinear mathematical models.
Matematicheskoe Modelirovanie 2, 112–118. in Russian, translated in English in
Sobol’ , I. (1993). Sensitivity analysis for non-linear mathematical models.
Mathematical Modeling & Computational Experiment (Engl. Transl.), 1993, 1,
407–414.

[2] Homma, T. and A. Saltelli (1996). Importance measures in global sensitivity
analysis of nonlinear models. Reliability Engineering and System Safety, 52,
1–17.


*Fiji Method:*

The sensitivity value selected for Fiji is the S~Ti~, the Total Effect Index of
X~i~.

This sensitivity value was selected to be reported for variables as it will
have larger values for S~Ti~ (approaching 1) being candidates, rather than
smaller (approaching 0) values, for reducing overall variance and therefore
uncertainty of the estimate calculations.

The total effect index of X~i~ is given by the following equations:

$$ S_{Ti}=\frac {E_{{\textbf {X}}_{\sim i}}\left(\operatorname {Var} _{X_{i}}(Y\mid \mathbf {X}_{\sim i})\right)}{\operatorname {Var} (Y)}=1-\frac {\operatorname {Var}_{{\textbf {X}}_{\sim i}}\left(E_{X_{i}}(Y\mid \mathbf {X}_{\sim i})\right)}{\operatorname {Var} (Y)} $$

As the effect of the uncertainty of X~i~ gets larger the $Var_{X_{~i}}$ gets
smaller so the remaining variance approaches 1.

- $Var_{X_{\sim i}}$: Variance of Y without the variance of X~i~, X~i~ is held
  at its nominal value
- ${\operatorname {Var} (Y)}$: variance of the Y model including the variance
  on all variables.
- $S_{Ti}$: Contribution of the uncertainty of X~i~ to the total variance


The second form of the equation was used:
$$
 S_{Ti}=1-\frac {\operatorname {Var}_{{\textbf {X}}_{\sim i}}\left(E_{X_{i}}(Y\mid \mathbf {X}_{\sim i})\right)}{\operatorname {Var} (Y)}
$$

In other words, the contribution of the variance of X~i~ standardised by the
total variance is equal to 1 minus the variance of the final estimate
calculation with the value of X~i~ fixed divided by the variance of the
original estimate calculation including the uncertainty of all variables.

Note: The sum of S~Ti~ for all variable analysed will not equal 1. So a
percentage will not be reported, just a fraction without a unit.


**Output**

- `TEI_Values`: The Total Effect Index values for each assessed parameter.

Produces a table which is used in section 5.3 Sensitivity Analysis of the FCPF
Monitoring Report.

## 3.2.	Modification of Code

- [] Todo: Code Modification needs work

There are a couple of use cases which may require the modification of the code:

1. Fiji methodological changes requires code to be updated/reviewed
2. Another country adopts the calculation code
3. Monitoring Period Report Tasks for new FCPF Report


The following sections provides guidance on how to perform these changes for
these use cases.

### 3.2.1.	Resulting from changes to Methodology

- If a default parameter is changed, the relevant parameter file will need to
  be updated.
- If a calculation equation is changed, the relevant calc file will need to be
  updated.
  + Associated Test documents will need to be updated
- New calculations or activities will need to be added to the
  `FijiNFMSCalculations` package and the drivers files.

### 3.2.2	Adoption of code for a new country context

- Country specific default parameters will need to be updated,
- Calculations in `FijiNFMSCalculations` Package to be reviewed and updated for
  the new countries activities and saved as a new package.
  + New calculations package should be referenced in the drivers files in
    EmRem, ER and data list sections.


### 3.2.3 Monitoring Period Report Tasks for new FCPF Report


- [] Todo: add detail - Monitoring Values files need to be updated for each new
  FCPF monitoring report.
  + This can be done in two ways:
    1. directly in the code files
    2. via FIMS

Each updating method depends on the updating party. Updating directly in the
code is useful in the case where the code can be sent to an external party who
does not have access to the FIMS.

- [] Todo: Add reference - See FIMS manual for editing in the FIMS. Link to
  manual- which will be saved in the FIMS.pdf


## 3.3.	Testing & Unit Testing

Unit testing is written for all packages.  Each test set includes some
examples which have been drawn from the Fiji data. These are run using the
`testthat` package.

Example of running the tests at the R prompt:

```
devtools::test()
```

See `?testthat` for more information.


There are also `chk` files. These files are the captured output of the drivers
with a known set of inputs. These inputs are provided in the `Data/preMonitoringReport`
directory. These values are mock data derived from Fiji data.

The output of a driver can be compared with the `chk` file to check weather the
output is normal. Below is an example of unix commands that will perform this
test:

```{make}
	Rscript -e 'source("./fiji_frl_all_R_code.R")'
	diff -U 1  ./Fiji_FRL_Results.txt ./Fiji_FRL_Results.chk
	Rscript -e 'source("./Fiji_ER_Estimate_Values.R")'
	diff -U 1  ./Fiji_ER_EstimateResults_Values.chk ./Fiji_ER_EstimateResults_Values.txt
	Rscript -e 'source("./Fiji_ER_Estimate_UC.R")'
	diff -U 1  ./Fiji_ER_EstimateResults_UC.chk ./Fiji_ER_EstimateResults_UC.txt
	Rscript -e 'source("./Fiji_ER_Estimate_Sensitivity.R")'
	diff -U 1  ./Fiji_ER_EstimateResults_Sensitivity.chk ./Fiji_ER_EstimateResults_Sensitivity.txt
```

Any code changes should be reflected in associated tests to ensure that the
quality of code is maintained.

**Note:**

Some of the tests use a `set.seed(number)` with an arbitrary number to ensure
that the tests are repeatable when using random number generation. The seed is
not required in the normal operation of the code.


# 4.	Packages

## Fiji NFMS Calculations

- [] Todo: Reference Package Documentation

The basic estimation calculations based on the methodology.

## Value with Uncertainty

- [] Todo: Reference Package Documentation

The R Object to encapsulate a value with an uncertainty model. These objects are
used in uncertainty propagation and sensitivity analysis.

## Monte Carlo Utils

- [] Todo: Reference Package Documentation

Utilities to run Monte Carlo simulations for a calculation function from the
Fiji NFMS calculations against a set of arguments.

## FCPF Monitoring Report Tables

- [] Todo: Reference Package Documentation
- [] Todo: separate FCPF Monitoring Report Table functions (currently in
  ../Funcs/TableCreationFunctions.R) into their own package.




